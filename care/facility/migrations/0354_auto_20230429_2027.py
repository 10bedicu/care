# Generated by Django 2.2.11 on 2023-04-17 04:06

from django.db import migrations


def migrate_prescriptions(apps, schema_editor):
    PatientConsultation = apps.get_model('facility', 'PatientConsultation')
    Prescription = apps.get_model('facility', 'Prescription')

    for consultation in PatientConsultation.objects.all():
        for advice in consultation.discharge_advice:
            Prescription.objects.create(
                frequency=advice['dosage'].upper(),
                dosage=advice['dosage_new'],
                medicine=advice['medicine'],
                days=advice['days'],
                notes=advice['notes'],
                route=advice['route'].upper(),
                consultation=consultation,
                is_prn=False,
                prescribed_by=consultation.created_by,
                is_migrated=True
            )
        for advice in consultation.prn_prescription:
            Prescription.objects.create(
                medicine=advice['medicine'],
                dosage=advice['dosage'],
                indicator=advice['indicator'],
                max_dosage=advice['max_dosage'],
                min_hours_between_doses=advice['min_time'],
                route=advice['route'].upper(),
                consultation=consultation,
                is_prn=True,
                prescribed_by=consultation.created_by,
                is_migrated=True
            )
    # Look at all daily round objects under this consultation
    # Fetch all prescriptions for that patient
    # For patients with multiple prescriptions :
    #   Start from the first prescription item and calculate how long it continued for
    #   Discontinued date is the first date when the prescription was removed or the discharge date if present
    #   Perform this for all prescriptions


class Migration(migrations.Migration):
    dependencies = [
        ('facility', '0353_auto_20230429_2026'),
    ]

    operations = [
        migrations.RunPython(migrate_prescriptions),
    ]
